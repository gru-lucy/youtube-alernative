(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[10],{d8f8:function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("q-page",{staticClass:"bg-black overflow-hidden",staticStyle:{height:"calc(100vh - 50px - var(--appbar-height, 0px))!important",padding:"1px"}},[s("VideoJsPlayer",{ref:"videoJsPlayer",staticClass:"full-width full-height",on:{openFile:e.addSubtitles}})],1)},r=[],i=(s("de6c"),s("dc89"),s("2425"),s("a1c1"),s("d558")),n=s("e3c7"),o=s("5584"),l=(s("7a76"),s("5c0c")),c=s.n(l),u=s("17de"),d=s.n(u);const h=s("bc7b"),p=s("d6fe");var y=f;async function f(e){console.log(e);const t=p.dirname(e),s=p.extname(e);let a=p.basename(e);if(a=a.slice(0,a.length-s.length),console.tag("Player","getSubtitleFromFilename").log({dirname:t,basename:a,ext:s}),!h.existsSync(t))throw new Error("dirname not found: "+t);const r=[v(),m()];let i=[];try{const e=h.readdirSync(t);i=await Promise.all(e.map((async e=>{if(!e.startsWith(a))return;const s=r.find((t=>e.endsWith(`.${t.ext}`)));if(!s)return;const i=p.join(t,e),n=await h.promises.readFile(i),o=s.convert(n);return console.log("sub","converted",!!o),o?{filename:i,src:URL.createObjectURL(new Blob([o])),id:e}:void 0}))).then((e=>e.filter((e=>!!e))))}catch(n){console.log(n)}return i}function m(){return{ext:"vtt",convert(e){const t=c.a.decode(e,d.a.detect(e)).replace(/^{[\\0-9A-Za-z&]*}/gm,"");return t}}}function v(){return{ext:"srt",convert(t){const s=c.a.decode(t,d.a.detect(t)).replace(/^{[\\0-9A-Za-z&]*}/gm,"");return e(s)}};function e(e){var s=e.replace(/\r+/g,"");s=s.replace(/^\s+|\s+$/g,"").replace(/\n\d+\n\d+/g,(e=>"\n"+e));var a=s.split(/\n{2,}/g),r="";if(a.length>0){r+="WEBVTT\n\n";for(var i=0;i<a.length;i+=1)r+=t(a[i])}return r}function t(e){var t="",s=e.split(/\n/);if(!s[0]||!s[1])return console.log(e),"";while(s.length>3){for(var a=3;a<s.length;a++)s[2]+="\n"+s[a];s.splice(3,s.length-3)}var r=0;if(!s[0].match(/\d+:\d+:\d+/)&&s[1].match(/\d+:\d+:\d+/)&&(t+=s[0].match(/\w+/)+"\n",r+=1),!s[r].match(/\d+:\d+:\d+/))return"";var i=s[1].match(/(\d+):(\d+):(\d+)(?:,(\d+))?\s*--?>\s*(\d+):(\d+):(\d+)(?:,(\d+))?/);return i?(t+=i[1]+":"+i[2]+":"+i[3]+"."+i[4]+" --\x3e "+i[5]+":"+i[6]+":"+i[7]+"."+i[8]+"\n",r+=1,s[r]&&(t+=s[r]+"\n\n"),t):""}}var g=s("d7df"),P=s("6422");const w=s("d310").isElectron();var b={name:"Player",mixins:[$(),R(),x(),H(),L(),A()],created(){g["a"].on("clear_player",(e=>{var t,s,a,r;console.log("IO: Clear Player",e);const i=null===(t=this.player)||void 0===t||null===(s=t.states)||void 0===s||null===(a=s.currentSources)||void 0===a||null===(r=a[0])||void 0===r?void 0:r.infoHash;i&&e.infoHash===i&&this.stop()}))},activated(){console.log("Player","$route.params",this.$route.params)}};let S=null;function $(){return{data(){return{player:null}},mounted(){this.player=this.$refs.videoJsPlayer.player},methods:{async setSource(e){if(console.log("Player","setSource",e),await this.player.promiseReady,S instanceof AbortController){const e=S.signal;e.aborted?console.log("Prev signal is aborted"):(console.log("Abort previous signal before setting source"),S.abort())}else console.log("sourceAbortCountroller is not an abort controller",S);S=new AbortController;try{await this.player.setSource(e,S.signal),w&&await this.addSubtitles()}catch(t){console.log("Set source error:",t)}},play(){this.player.play()},async stop(){var e;(this.player.states.isPiP&&this.player.setPiP(!1),this.player.states.isFullscreen&&this.player.setFullscreen(!1),this.player.instance)&&(console.log(this.player.instance,this.player.instance.reset),null===(e=this.player.instance)||void 0===e||e.reset());if("removeAllListeners"in n["ipcRenderer"])n["ipcRenderer"].removeAllListeners("stream-address");else try{n["ipcRenderer"].off&&n["ipcRenderer"].off("stream-address")}catch(t){console.warn("Failed to remove stream listeners",t)}await this.player.stop(),console.log("Dispatch remotePlay reset"),await o["a"].dispatch("resetRemotePlay")},async pause(e){e&&(this.player.states.isPiP&&this.player.setPiP(!1),this.player.states.isFullscreen&&this.player.setFullscreen(!1)),this.player.states.isPaused||await this.player.pause()},setPiP(e){this.player.setPiP(e)},seek(e){this.player.seek(e)},getCurrentSourceData(){var e,t,s,a;const r=null!==(e=null===(t=this.player)||void 0===t||null===(s=t.states.currentSources)||void 0===s||null===(a=s[0])||void 0===a?void 0:a.src)&&void 0!==e?e:null,i=e=>Array.from(new URL(e).searchParams.entries()).reduce(((e,[t,s])=>({...e,[t]:s})),{});if(!r)return null;const n=this.player.states.currentSources[0];return{url:r,params:i(r),infoHash:n.infoHash}},async addSubtitles(){const e=this.player.states.currentSources[0];let t;if(e.filename?t=e.filename:e.file&&(t=e.file.path),!t)return;const s=await y(t);console.log("Player","subtitles",s),s&&s.forEach(((e,t)=>{this.player.addTrack(e),0===t&&this.player.enableTrack(e.id)}))}},activated(){const e=this.$refs.videoJsPlayer.$el.querySelector(".video-js-player>.video-js");e.focus()}}}function R(){return{mounted(){this.$watch((()=>{var e,t;if("play_source"===(null===(e=this.$route.params)||void 0===e||null===(t=e.action)||void 0===t?void 0:t.type))return this.$route.params.action.source}),(async s=>{if(!s)return console.log("no source");console.log("Player","mixinSourcePlay","src",s.src),s.filename=e(s),s.type=t(s),console.log("Player","mixinSourcePlay","filename",s.filename),console.log("Player","mixinSourcePlay","type",s.type),await this.stop(),await this.setSource(s),this.play()}),{immediate:!0})}};function e(e){let t;return t=e.src.startsWith("play://")?decodeURI(new URL(e.src).pathname).slice(3):decodeURI(e.src),t}function t(e){return"video/mp4"}}function x(){return{mounted(){this.$watch((()=>{var e,t;if("play_file"===(null===(e=this.$route.params)||void 0===e||null===(t=e.action)||void 0===t?void 0:t.type))return this.$route.params.action.file}),(async e=>{if(!e)return console.log("no file");console.log("Player","mixinFilePlay","file",e),await this.stop(),await this.setSource({src:URL.createObjectURL(e),type:e.type,file:e}),this.play()}),{immediate:!0})}}}function H(){return w||Object(i["a"])()?{mounted(){this.$watch((()=>{var e,t;if("play_remote"===(null===(e=this.$route.params)||void 0===e||null===(t=e.action)||void 0===t?void 0:t.type))return o["a"].state.video.currentVideo.remotePlay}),(async t=>{if(!t)return;console.log("remotePlay",t,o["a"].state.video.currentVideo.infoHash),await this.stop(),o["a"].state.video.currentVideo.infoHash&&this.$nextTick((()=>{console.log("Dispatch remote",o["a"].state.video.currentVideo.infoHash),o["a"].dispatch("remotePlay",o["a"].state.video.currentVideo.infoHash)})),this.player.loadingState=!0;const s=await e.call(this);s&&this.play(),this.player.loadingState=!0}),{immediate:!0})}}:{};async function e(){const e=o["a"].state.video.currentVideo.infoHash,s=this.getCurrentSourceData();if(s&&s.infoHash===e)return;await this.stop(),await this.$nextTick();const a=await i.call(this);if(!a)return;const r=l(a,{infoHash:e});console.log(r);try{return await this.setSource(r),r.src.startsWith("http://")&&await t.call(this,r),!0}catch(c){console.error("Player","error",c)}async function i(){const e=e=>new Promise((t=>setTimeout((()=>t(null)),e))),t=await Promise.race([e(1e4),new Promise((e=>{n["ipcRenderer"].once("stream-address",((t,s)=>e(s))),n["ipcRenderer"].send("get-stream-address")}))]);var s;t?(null!==(s=t.filepath)&&void 0!==s||(t.filepath="win32"===process.platform?decodeURI(t.address).replace("play:///","").replace(/\//g,"\\"):decodeURI(t.address).replace("play://","")),console.log("Player","streamAddress",t)):console.log("Player","streamAddress").tag.red("timeout");return t}function l(e,{infoHash:t}){let s=e.address,a=e.filepath;return s.startsWith("play://")&&(s+=`?infoHash=${t}`,a||(a=decodeURI(new URL(s).pathname).slice(Object(P["d"])()?3:2))),"win32"===process.platform&&(a=a.replace(/\//g,"\\")),{src:s,type:null,filename:a,infoHash:t}}}async function t(e){const{src:t}=e;if(!/wait=0$/gm.test(t))return;const s=o["a"].state.setting.videoCacheTime;if(0===s)return;const a=60*s/this.player.states.duration,r=t.replace(/wait=.*/gm,`wait=${a}`),i=this.player.states.currentTime,n=e=>this.player.setSource(e);await n(Object.assign(e,{src:r})),this.seek(i)}}function L(){return{beforeRouteLeave(t,s,a){var r;if("signedIn"!==(null===(r=this.$store.state.account)||void 0===r?void 0:r.authState))return this.pause(),a();e.call(this),a()},beforeRouteEnter(e,s,a){a((e=>t.call(e)))},mounted(){const e=()=>"Player"===this.$route.name;this.$watch((()=>{var e;return null===(e=this.player)||void 0===e?void 0:e.states.isPiP}),(t=>{t||this.player.states.isPaused||e()||this.$router.push({name:"Player"})}))}};function e(){var e,t;this.player&&0!==(null!==(e=null===(t=this.player.states.currentSources)||void 0===t?void 0:t.length)&&void 0!==e?e:0)&&(this.player.states.isPaused||this.player.states.isPiP||"object"!==typeof this.player.states.loadingState&&w&&this.setPiP(!0))}function t(){this.player&&this.player.states.isPiP&&this.setPiP(!1)}}function A(){return{inject:["io"],mounted(){this.$amplify.addOnAuthStateChangedListener((async e=>{console.log("Player","PiP","signedOut",{authState:e}),"signedOut"===e&&await this.pause(!0)})),(w||Object(i["a"])())&&n["ipcRenderer"].on("pause-player",(()=>this.pause(!0))),this.io.on("server_progress",e.bind(this)),this.io.on("update_subtitleList",t.bind(this)),this.io.on("clear_player",s.bind(this))}};function e(e){var t,s,a,r,i,n;const o=()=>"Player"===this.$route.name;if(!o())return;const l=null!==(t=null===(s=this.player)||void 0===s||null===(a=s.states.currentSources)||void 0===a||null===(r=a[0])||void 0===r?void 0:r.src)&&void 0!==t?t:null;if(!l)return;const c=null!==(i=null===(n=e.find((e=>l.includes(e.name))))||void 0===n?void 0:n.progress)&&void 0!==i?i:null;function u(e){const t=[],s=e.length;let a=e[0],r=1;for(let i=1;i<s;i++)if(e[i]===a&&i<s-1)r+=1;else{if(e[i+1]===a){r+=1;continue}i===s-1&&(r+=1),r&&t.push({color:1===a?"gold":"transparent",length:r/s*100}),a=e[i],r=1}}c&&u(c)}function t(e,t){console.log("Player","io$update_subtitleList",{infoHash:e,subtitleList:t})}async function s({status:e,infoHash:t}){var s,a,r,i;const n=null!==(s=null===(a=this.player)||void 0===a||null===(r=a.states.currentSources)||void 0===r||null===(i=r[0])||void 0===i?void 0:i.src)&&void 0!==s?s:null,o=e=>Array.from(new URL(e).searchParams.entries()).reduce(((e,[t,s])=>({...e,[t]:s})),{});if(!n)return;const{infoHash:l}=o(n);async function c(){await this.stop()}l===t&&(/^play:\/\//gm.test(n)&&"paused"===e||(await c.call(this),await new Promise((e=>setTimeout(e,500))),/^http/gm.test(n)&&this.$q.notify(this.$t("stop_stream_player")),/^play:\/\//gm.test(n)&&this.$q.notify(this.$t("stop_player"))))}}var U=b,_=s("2b5f"),j=s("9b72"),O=s("09a4"),k=s.n(O),C=Object(_["a"])(U,a,r,!1,null,null,null);t["default"]=C.exports;k()(C,"components",{QPage:j["a"]})}}]);